<!--
It's messy, I know.
-->
<!doctype html>
<html class="has-background-black-bis has-text-white">

<head>
  <title>i386chat</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">
  <script src="https://i386.tech/autolinker.js"></script>
  <style>
    @keyframes rainbowk {

      100%,
      0% {
        color: rgb(255, 0, 0);
      }

      8% {
        color: rgb(255, 127, 0);
      }

      16% {
        color: rgb(255, 255, 0);
      }

      25% {
        color: rgb(127, 255, 0);
      }

      33% {
        color: rgb(0, 255, 0);
      }

      41% {
        color: rgb(0, 255, 127);
      }

      50% {
        color: rgb(0, 255, 255);
      }

      58% {
        color: rgb(0, 127, 255);
      }

      66% {
        color: rgb(0, 0, 255);
      }

      75% {
        color: rgb(127, 0, 255);
      }

      83% {
        color: rgb(255, 0, 255);
      }

      91% {
        color: rgb(255, 0, 127);
      }
    }

    .rainbow {
      animation: rainbowk 5s infinite;
    }

    strong {
      color: white;
    }

    #messages {
      list-style-type: none;
      margin: 0;
      padding: 5px 10px;
      margin-bottom: 55px;
    }

    form {
      background: #000;
      padding: 3px;
      position: fixed;
      bottom: 0;
      width: 100%;
    }

    .c {
      width: 100%;
    }
  </style>
</head>

<body class="has-background-black-bis has-text-white">
  <ul id="messages"></ul>
  <form action="">
    <div class="field has-addons">
      <div class="control is-expanded">
        <input class="input" id="m" type="text" placeholder="Type your message.." autocomplete="off">
      </div>
      <div class="control">
        <button class="button is-info">
          Send
        </button>
      </div>
    </div>
  </form>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script>
    let rainbow = localStorage.getItem("rainbow") || 0; // Hahaha the code's stored in my localStorage and nobody elses!
    let bio = localStorage.getItem("bio") || "I am a user of wchatbox.";
    let lastPM = 0;
    let disconnected = false;
    let currentRoom = "general";
    let ignored = [];
    let nickname =
      ""; // This is only used to send it to the server, it's always validated by your socketID (that is not the ID below) each time!
    let id = 0; // If you change this you wouldn't be able to receieve pings anymore so it's kinda detrimental to you.
    let auto_scroll = localStorage.getItem('auto_scroll') || true;
    let pings_muted = localStorage.getItem('pings_muted') || false;
    var socket = io();
    socket.on('join', function (jc) {
      if (disconnected == true) return;
      $("#messages").append(
        `<h3>${jc} user(s) are online across all rooms. You're in <i>${currentRoom}</i></h3><li>Type //help for commands.</li>`
      )
      nickname = prompt("What's your nickname?") || "Username";
      socket.emit("nickname_selection", nickname);
      socket.emit("bio_change", {
        onConnect: true,
        bio: bio
      })
      if (rainbow !== 0) socket.emit("rainbow_name_code", rainbow);
    });

    function arrayRemove(arr, value) {
      return arr.filter(function (ele) {
        return ele != value;
      });
    }
    $('form').submit(function (e) {
      e.preventDefault(); // prevents page reloading
      msg = $("#m").val();
      if (msg === "") return;
      if (msg.length > 250) return alert("Message is too large to send (250 character max).");
      if (msg.startsWith("//")) {
        const args = msg.slice("//").trim().split(/ +/g);
        const command = args.shift().toLowerCase();
        console.log(command);
        if (command == "//online") {
          socket.emit("get_online_users", true);
        } else if (command == "//astoggle") {
          auto_scroll = !auto_scroll;
          localStorage.setItem('auto_scroll', auto_scroll);
          $("#messages").append($("<li>").text(`auto_scroll is ${auto_scroll}!`));
          if (auto_scroll == true) {
            $(document).scrollTop($(document).height());
          }
        } else if (command == "//mutetoggle") {
          pings_muted = !pings_muted;
          localStorage.setItem('pings_muted', pings_muted);
          $("#messages").append($("<li>").text(`pings_muted is ${pings_muted}!`));
          if (auto_scroll == true) {
            $(document).scrollTop($(document).height());
          }
        } else if (command == "//help") {
          $("#messages").append($("<li>").text(
            "wchatbox commands: //mutetoggle, //astoggle, //help, //online, //whisper, //reply, //room, //rainbow, //bio, //ignore."
          ));
          $("#messages").append($("<li>").text(
            "To get a user ID click on their name in chat."));
          if (auto_scroll == true) {
            $(document).scrollTop($(document).height());
          }
        } else if (command == "//whisper") {
          if (!args[0]) return $("#messages").append($("<li>").text(
            "Usage: //whisper <id (click on a username to get it!)> <message>"));
          if (!args[1]) return $("#messages").append($("<li>").text(
            "Usage: //whisper <id (click on a username to get it!)> <message>"));
          socket.emit("private_message", {
            text: args.slice(1).join(" "),
            author: nickname,
            idReceiver: args[0]
          })
          $("#messages").append($("<li>").text(
            `Sent "${args.slice(1).join(" ")}" to ${args[0]}.`));
          if (auto_scroll == true) {
            $(document).scrollTop($(document).height());
          }
        } else if (command == "//reply") {
          if (lastPM == 0) return $("#messages").append($("<li>").text(
            "Nobody to reply to!"));
          if (!args[0]) return $("#messages").append($("<li>").text(
            "Usage: //reply <message>"));
          socket.emit("private_message", {
            text: args.join(" "),
            author: nickname,
            idReceiver: lastPM
          })
          $("#messages").append($("<li>").text(
            `Sent "${args.join(" ")}" to ${lastPM}.`));
          if (auto_scroll == true) {
            $(document).scrollTop($(document).height());
          }
        } else if (command == "//room") {
          if (!args[0]) return $("#messages").append($("<li>").text(
            "Usage: //room change,current,list [change: <to room>]"));
          switch (args[0].toLowerCase()) {
            case "change":
              if (!args[1]) return $("#messages").append($("<li>").text(
                "Usage: //room change <room>"));
              previousRoom = currentRoom;
              currentRoom = args[1];
              socket.emit("room_change", {
                author: "",
                room: args[1],
                previousRoom
              })
              $("#messages").append($("<li>").text(
                `You're now in ${currentRoom}.`));
              if (auto_scroll == true) {
                $(document).scrollTop($(document).height());
              }
              break;
            case "current":
              $("#messages").append($("<li>").text(
                `You're currently in ${currentRoom}.`));
              if (auto_scroll == true) {
                $(document).scrollTop($(document).height());
              }
              break;
            case "list":
              socket.emit("list_all_rooms");
              if (auto_scroll == true) {
                $(document).scrollTop($(document).height());
              }
              break;
          }
        } else if (command == "//rainbow") {
          x = args[0];
          if (!x) x = "";
          socket.emit("rainbow_name_code", x);
        } else if (command == "//bio") {
          if (!args[0]) return $("#messages").append($("<li>").text(
            "Usage: //bio <new bio>"));
          if (args.join(" ").length > 125) return $("#messages").append($("<li>").text(
            "Bio text limit is 125."));
          localStorage.setItem('bio', args.join(" "));
          socket.emit("bio_change", {
            onConnect: false,
            bio: args.join(" ")
          })
          if (auto_scroll == true) {
            $(document).scrollTop($(document).height());
          }
        } else if (command == "//ignore") {
          if (!args[0]) return $("#messages").append($("<li>").text(
            "Usage: //ignore <id>"));
          if (ignored.includes("" + args.join(" "))) {
            ignored = arrayRemove(ignored, args.join(" "));
            $("#messages").append($("<li>").text(
              "Removed " + args.join(" ") + " from the ignored list."));
          } else {
            ignored.push(args.join(" "));

            $("#messages").append($("<li>").text(
              `Added ${args.join(" ")} to the ignore list.`));
          }
          if (auto_scroll == true) {
            $(document).scrollTop($(document).height());
          }
        }
      } else {
        socket.emit('chat_message', {
          text: $('#m').val(),
          author: nickname,
          room: currentRoom
        });
        //  $('#messages').append($('<li>').text(nickname + " > " + $('#m').val()))
      }
      $('#m').val('');
      return false;

    });
    socket.on('id', (ide) => {
      id = ide;
    })
    socket.on('chat_message', function (msg) {
      if (ignored.includes("" + msg.id)) return;
      st2 = ``;
      if (msg.id !== id) {
        if (msg.text.includes(`[${nickname}]`)) {
          st2 = `border-radius:1.2px;background-color:#f5cb42;color:black;`;
          if (pings_muted == false) {
            var audio = new Audio('https://i386.tech/juntos.mp3');
            audio.play();
          }
        }
      }
      $('#messages').append($(
        `<li><a ${msg.rainbow} style="color:#${msg.colour};text-decoration:none;" onclick="alert('${msg.bio}\\nUser ID: ${msg.id}');">${msg.author}</a> > <span style="${st2}">${Autolinker.link(msg.text)}</span><li>`
      ));

      if (auto_scroll == true) {
        $(document).scrollTop($(document).height());
      }

    });
    socket.on('private_message', function (msg) {
      if (ignored.includes("" + msg.id)) return;

      if (pings_muted == false) {
        var audio = new Audio('https://i386.tech/juntos.mp3');
        audio.play();
      }
      $('#messages').append($(
        `<li><a ${msg.rainbow} style="color:#${msg.colour};text-decoration:none;" onclick="alert('${msg.bio}\\User ID: ${msg.id}');">${msg.author} (PM)</a> > <span>${Autolinker.link(msg.text)}</span><li>`
      ));
      lastPM = msg.id;
      if (auto_scroll == true) {
        $(document).scrollTop($(document).height());
      }

    });
    socket.on('user_join', function (msg) {
      $('#messages').append($('<li>').text("" + msg.text));

      if (auto_scroll == true) {
        $(document).scrollTop($(document).height());
      }

    });
    socket.on("command_output", function (m) {
      $("#messages").append(m);

      if (auto_scroll == true) {
        $(document).scrollTop($(document).height());
      }

    });
    document.getElementById('m').onclick = function () {

      if (auto_scroll == true) {
        $(document).scrollTop($(document).height());
      }

    }
    $('#m').on('input', function () {

      if (auto_scroll == true) {
        $(document).scrollTop($(document).height());
      }

    });
    socket.on("disconnect", () => {

      $("#messages").append($("<li>").text("You've been disconnected, please refresh to reconnect."));
      if (auto_scroll == true) {
        $(document).scrollTop($(document).height());
      }
      disconnected = true;

    })
  </script>
</body>

</html>